@startuml qsdemo



package Global {

  class ScoringStrategy {
    name String
    evalMove(GameMove): float
    evalQuest(Quest, ParticipatingGuild): QBadge[]
  }

  class AccountService {
    name String
    url String
  }

  class QuestRegistry {
    quests(status): Quest[]
  }

  class GuildRegistry {
    guilds(): ParticipatingGuild[]
    scores(ParticipatingGuild): GlobalGuildScores
  }

  class UserRegistry {
    users[]: User[]
    badges(User): UBadge[]
  }

  enum QuestStatus {
    draft
    registration
    ongoing
    scoring
    finished
  }

  class TurnStrategy {
    synchronous boolean
    turnLength interval
  }

}


package ServerInfo {
  class User {
    handle String
    name String
    email Strin
  }
  class Account {
    User user
    service AccountService
    string id
  }
  Account --> "1" AccountService
  User "1" --> "*" Account

  class GuildData {
    name String
    admin User
    accept(Quest)
    register_score(GuildScore): QuestScore
  }
  QuestData o--> "1" User : > sponsor
  class QuestData {
    name LangString
    description LangString
    scoring ScoringStrategy
    turns TurnStrategy
    sponsor User
    status QuestStatus
    admin User
    scoreMove(GameMove): GameMoveScore[]
    play(ProposedGameMove): GameMove
    ' Maybe have a QProposedGameMove in case of non-synchronous turn strategy
    register(Quest): ParticipatingGuild
    ' will also create the Avatars from the Quest's castings
  }

  GuildData o--> "1" User : > leader
}


package QuestInfo {

  object aQuest {
    name String
  }
  QuestData <|-- aQuest


  class ParticipatingGuild {
    name String
    server URL
  }

  QuestData "1" --> "*" ParticipatingGuild

  class Avatar {
    guild ParticipatingGuild
    handle String
    origin Casting
  }

  ParticipatingGuild "1" --> "*" Avatar

  class GameMove {
    creator Avatar?
    basedOn ProposedGameMove?
    submitted timestamp
    made_visible timestamp
  }

  QuestData "1" --> "*" GameMove
  GameMove "1" o--> "0..1" Avatar
  QuestData o--> ScoringStrategy
  
  class GameMoveScore {
    value float
    move GameMove
    strategy ScoringStrategy
  }
  GameMove "1" <-- GameMoveScore
  GameMoveScore --> "1" ScoringStrategy
  class GuildScore {
    ParticipatingGuild guild
    total float
    moves GameMoveScore[]
    strategy ScoringStrategy
    signature crypto
  }
  ParticipatingGuild o--> "*" GuildScore
  GuildScore --> "*" GameMoveScore
  GuildScore --> "1" ScoringStrategy


  class QBadge {
    avatar Avatar
    from_score GameMoveScore
    signature crypto
  }

  GameMoveScore "1" *--> "*" QBadge
  Avatar "1" --> "*" QBadge

}


package GuildInfo {

  object aGuild {
    name String
  }
  GuildData <|-- aGuild

  ' GuildRegistry --> "*" GuildData
  ' GuildRegistry -> "*" GlobalGuildScore

  ' UserRegistry --> "*" User
  ' UserRegistry -> "*" UBadge

  ParticipatingGuild .> "*" GuildData
  GuildData --> "*" Quest

  GuildData "*" <--> "*" User

  (User , GuildData) .. Membership


  class Membership {
    user User
    boolean confirmed
  }

  class Casting {
    quest Quest
    user User
    handle avatar
    role Role
  }

  User "1" --> "*" Casting


  Casting "1" <.o "1" Avatar

  Quest "1" --> "*" QuestScore

  class Quest {
    name LangString
    status QuestStatus
    server URL
    proposed timestamp
    accepted timestamp
  }

  Quest o.> "*" QuestData

  class QuestScore {
    Quest quest
    total float
    origin GuildScore
  }


  GuildScore "1" <.o "1" QuestScore


  class UBadge {
    casting Casting
    from QuestScore
    origin QBadge
  }

  UBadge "1" o.> "1" QBadge
  QuestScore "1" --> "*" UBadge

  Casting "1" <--> "*" UBadge

  Quest "1" --> "*" Casting

  enum PubState {
    proposed
    submitted
    visible
    ' visible and submitted are the same for v1
  }

  class Turn {
    quest Quest
    state PubState
    created timestamp
    created timestamp
    submitted timestamp
    visible timestamp
  }

  Quest o--> "*" Turn
  Turn --> "1..*" ProposedGameMove
  Turn --> "1" PubState

  class ProposedGameMove {
    quest Quest
    turn Turn
    contributors Casting[]
    state PubState
    created timestamp
    submitted timestamp
    visible timestamp
  }
  GameMove "1" o.> "0..1" ProposedGameMove
  ParticipatingGuild "1" <-- "*" ProposedGameMove
  ProposedGameMove "*" --> "1..*" Casting
  ProposedGameMove "*" --> "1" PubState

  class GlobalGuildScore {
    float total
    strategy ScoringStrategy
    scores QuestScore[]
  }

  GuildData "1" --> "*" GlobalGuildScore
  GlobalGuildScore --> "1" ScoringStrategy
  GlobalGuildScore --> "*" QuestScore

}


@enduml
